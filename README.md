# 四氟化碳传感器系统

## 项目概述
项目名称：四氟化碳(CF4)气体浓度检测系统
核心功能：实时监测环境中CF4气体浓度并转换为标准模拟量输出
应用场景：工业环境气体监测、安全防护系统

## 系统功能
- 实时检测CF4气体浓度
- 将浓度值转换为标准模拟量输出信号(通过DAC7311)
- 支持故障检测与报警输出
- LED状态指示功能
- 支持参数配置与系统校准（暂不开发此部分）

## 硬件架构
- 微控制器：STM32F103C8T6，基于ARM Cortex-M3内核，最高工作频率72MHz
- 气体传感器：四氟化碳(CF4)专用传感器，通过USART3接口通信
- 数模转换器：DAC7311，12位分辨率，使用GPIO接口模拟SPI通讯时序控制
- 显示模块：OLED显示屏，通过I2C1接口控制
- 通信接口：
  - USART1(PA9-TX, PA10-RX)：与上位机通信，用于系统调试和参数配置
  - USART3(PB10-TX, PB11-RX)：与气体传感器建立通信，用于获取传感器数据
  - I2C1(PB6-SCL, PB7-SDA)：与OLED显示屏通信，显示系统运行状态
- 控制输出：
  - DAC7311接口(PB13-CLK, PB14-DIN, PB15-SYNC)：输出0-3.3V模拟电压信号
- 状态指示：
  - LED1(PA1)：系统状态指示（初始低电平，推挽输出，内部下拉，高速模式）
    - 初始化阶段：闪烁（间隔100ms）
    - 预热阶段：常亮
    - 工作阶段：常亮
  - LED2(PA2)：工作状态指示（初始低电平，推挽输出，内部下拉，高速模式）
    - 初始化阶段：熄灭
    - 预热阶段：闪烁（间隔100ms）
    - 工作阶段：每次DAC7311成功更新后点亮200ms，然后熄灭等待下次更新
- 用户输入（预留，暂不开发）：
  - KEY1(PA0)：功能按键
  - KEY2(PC13)：功能按键

### DAC7311 时序逻辑

#### 电气特性要求
- 电源电压（VDD）：2.7V ~ 5.5V
- 逻辑电平：
  - 输入低电平（VIL）：最大0.8V
  - 输入高电平（VIH）：最小2.0V
  - 输出低电平（VOL）：最大0.4V
  - 输出高电平（VOH）：最小VDD-0.8V

#### 时序参数要求
- fSCLK：最大30MHz（时钟频率）
- tCYC：最小33ns（时钟周期）
- tCH：最小10ns（时钟高电平宽度）
- tCL：最小10ns（时钟低电平宽度）
- tDS：最小5ns（数据建立时间）
- tDH：最小5ns（数据保持时间）
- tSYNC：最小20ns（SYNC低电平持续时间）
- tSYNCH：最小20ns（SYNC高电平持续时间）

#### 工作模式（通过[15:14]位控制）
- 00：正常工作模式
- 01：输出接1kΩ到GND
- 10：输出接100kΩ到GND
- 11：高阻态

#### 完整时序流程
1. **初始化**：
   - 上电后，DAC输出自动复位为零电平。
   - 在首次通信前，建议等待至少1μs。

2. **数据传输**：
   - **开始传输**：
     - SYNC拉低，开始传输。
     - CLK保持低电平。
     - 等待至少20ns（tSYNC）。
   - **传输16位数据**：
     - 对每一位数据：
       1. CLK保持低电平至少10ns。
       2. 在CLK上升沿前设置DIN数据至少5ns。
       3. CLK上升沿锁存数据。
       4. 保持数据稳定至少5ns。
       5. CLK下降沿准备下一位。
   - **结束传输**：
     - 最后一位数据传输完成。
     - CLK回到低电平。
     - SYNC拉高，结束传输。
     - DAC在SYNC上升沿更新输出。

3. **输出更新**：
   - 在SYNC上升沿，DAC将锁存的12位数据转换为模拟输出。
   - 转换时间典型值为8μs。
   - 建议两次传输间隔至少10μs。

#### 注意事项
- **掉电模式切换**：
  - 进入掉电模式时，输出会逐渐降至0V。
  - 退出掉电模式时，输出会恢复到之前的电压值。

- **参考电压**：
  - 内部参考电压为VDD。
  - 输出范围：0V到VDD。
  - 输出电压 = (VDD × D)/4096，其中D为12位DAC数据。

- **错误处理**：
  - 如果在传输过程中SYNC提前拉高，当前传输将被取消。
  - 如果传输的数据少于16位，DAC输出不会更新。
  - 保留位（[13:12]）如果不是00，可能导致未定义行为。

  

## 3. 软件架构详解

### 3.1 驱动层
- **STM32 HAL库**：硬件抽象层，提供底层外设访问接口
- **DAC7311驱动模块**：
  - 初始化DAC7311通信接口
  - 实现数据转换函数
  - 提供电压输出控制
- **UART通信模块**：
  - 配置串口参数(波特率，数据位，校验位)
  - 实现数据收发函数
  - 处理通信异常
- **GPIO控制模块**：
  - 配置引脚功能
  - 控制LED状态
  - 读取按键状态
- **I2C通信模块**：
  - 配置I2C参数
  - 实现与OLED显示屏的数据传输

### 3.2 传感器通信层
- **传感器协议实现**：
  - 根据《单一模组传感器通讯协议v2.5s-YK.pdf》文档
  - 实现命令封装与发送
  - 数据帧格式部分
    - 波特率：9600
    - 停止位：1 位
    - 数据位：8 位
    - 校验：无校验
  - 发送数据帧结构
    - 1、 发送头字节\设备类型（Byte0） 0xAA
    - 2、 设备地址（Byte1） 传感器默认0x00，
    - 3、 命令（Byte2）
    - 4、 命令内容（Byte3 ~Byte7）
    - 5、校验位（Byte8：校验从Byte0~Byte7） Btye8 = 求和Σ（byte0~byte7） \> 取反\> 加1
    - 6、发送结束字节（Byte9） 0xBB
  - 应答数据帧结构
    传感器返回：
    - 1、发送头字节\设备类型（Byte0） 0x55
    - 2、 命令（Byte1）
    - 3、 响应（Byte2）：0x01：命令正确且执行，0x02：命令正确但执行错误，0x03：命令错误，0x04无零点信息（不能进行标定）
    - 4、 命令内容（Byte3）量程低16位高字节
    - 5、 命令内容（Byte4）量程低16位低字节
    - 5、 命令内容（Byte5）量程高16位高字节
    - 5、 命令内容（Byte6）量程高16位低字节
    - 5、 状态（Byte7） 00.未标定 01.正常工作中 002.零点平移中 03.标定过程中 04.故障
    - 6、校验位（Byte8：校验从Byte0~Byte7） Byte8 = 求和Σ（byte0~byte7） \> 取反\> 加1
    - 7、发送结束字节（Byte9） 0xAA

  - 数据解析说明
    所有返回数据（浓度值、量程值、零点值等）均采用32位解析方式：
    - 低16位：由Byte3（高字节）和Byte4（低字节）组成
    - 高16位：由Byte5（高字节）和Byte6（低字节）组成
    - 数据组合方式：(高16位 << 16) | 低16位
    示例：
    - 接收数据：55 04 01 FF FF 00 00 01 A7 AA
    - Byte3-4：FF FF = 0xFFFF（低16位）
    - Byte5-6：00 00 = 0x0000（高16位）
    - 最终值：0x0000FFFF
    
    注：此解析方式适用于所有数据读取命令（0x03：读取浓度，0x04：读取量程，0x05：读取零点值）

- **数据采集流程**：
  - 周期性发送查询命令
  - 接收并解析传感器返回数据
  - 处理通信超时与错误

### 3.3 应用逻辑层
- **系统初始化**：
  - 外设初始化
  - 参数配置
  - 状态指示
- **数据处理算法**：
  - 根据零点值、量程值和当前浓度值计算实际气体浓度
  - 将浓度值映射到0-4095范围内(对应0-3.3V输出)
  - 计算输出电流(4-20mA)
- **运行状态管理**：
  - 系统启动预热(1分钟)
  - 正常运行模式
  - 错误处理

### 3.4 用户接口层
- **OLED显示模块**：
  - 初始化OLED显示
  - 界面布局设计
  - 信息更新机制
- **调试信息输出**：
  - 通过USART2输出系统状态
  - 错误日志记录

## 4. 详细工作流程

### 4.1 系统启动流程
1. **初始化阶段**（1秒）：
   - LED1闪烁（间隔100ms），LED2熄灭
   - 初始化所有外设（GPIO、I2C1、USART1、USART3）
   - 初始化OLED显示屏
   - 初始化DAC7311
   - 初始化传感器通信
   - 使用05指令检查传感器通信状态

2. **预热阶段**（3秒）：
   - LED1常亮，LED2闪烁（间隔100ms）
   - OLED显示预热倒计时
   - 每秒使用05指令检查传感器通信状态
   - 不进行浓度查询，避免获取不准确的数据

3. **工作阶段**：
   - LED1常亮
   - LED2随DAC7311更新而变化（更新后亮200ms）
   - 每500ms更新一次传感器数据
   - 每1000ms更新一次显示内容
   - 实时监测传感器通信状态

### 4.2 错误处理机制
1. **初始化错误**：
   - OLED初始化失败：显示"OLED Init Failed!"
   - DAC7311初始化失败：显示"DAC Init Failed!"
   - 传感器初始化失败：显示"Sensor Error!"和错误代码

2. **运行时错误**：
   - 连续3次传感器通信失败进入错误状态
   - LED1和LED2同时闪烁（错误状态）
   - OLED显示错误信息
   - 系统继续尝试恢复通信

### 4.3 数据处理流程
1. **传感器数据获取**：
   - 获取浓度值（03指令）
   - 获取量程值（04指令）
   - 获取零点值（05指令）

2. **数据转换**：
   - 根据公式计算实际浓度：
     ```
     输出值 = (浓度值 - 零点值) * 4096 / (量程值 - 零点值)
     ```
   - 将12位数据（0-4095）转换为电压值（0-3.3V）
   - 计算对应的电流值（4-20mA）

3. **显示更新**：
   - 显示当前浓度值（PPM）
   - 显示量程值（Range）
   - 显示零点值（Zero）
   - 显示DAC输出值（0-4095）

### 4.4 通信协议实现
1. **传感器通信**：
   - 波特率：9600
   - 数据格式：8位数据，1位停止，无校验
   - 通信超时：发送500ms，接收1000ms
   - 支持3次重试机制

2. **DAC7311控制**：
   - 使用GPIO模拟SPI时序
   - 时钟频率控制在30MHz以下
   - 16位数据传输（4位控制位 + 12位数据）

## 5. 代码模块划分

### 5.1 需要开发的文件
- **dac7311.c/h**：DAC7311驱动实现，提供数模转换功能
- **sensor.c/h**：传感器通信协议实现，负责与气体传感器交互
- **oled.c/h**：OLED显示屏驱动，负责信息显示
- **main.c**：主程序，实现核心业务逻辑

### 5.2 主要函数设计
- **DAC7311模块**：
  - DAC7311_Init()：初始化DAC接口
  - DAC7311_SetValue(uint16_t value)：设置DAC输出值
- **传感器模块**：
  - Sensor_Init()：初始化传感器通信
  - Sensor_GetZeroPoint()：获取零点值
  - Sensor_GetRange()：获取量程值
  - Sensor_GetConcentration()：获取当前浓度值
- **OLED模块**：
  - OLED_Init()：初始化OLED显示屏
  - OLED_ShowString(uint8_t x, uint8_t y, char *str)：显示字符串
  - OLED_ShowValue()：显示各项参数值
- **应用层**：
  - App_Init()：应用初始化
  - App_ProcessData()：数据处理与输出控制
  - App_UpdateDisplay()：更新显示信息

## 6. 重要算法与关键技术
- **浓度值映射算法**：将传感器浓度值映射到0-4095范围
  - 计算公式：outputValue = (currentConc - zeroPoint) * 4095 / (rangeValue - zeroPoint)
- **12位DAC数据封装**：
  - 按照DAC7311数据格式要求封装数据
  - 通过位操作实现高效传输
- **传感器通信协议解析**：
  - 帧格式解析
  - 校验和计算
  - 错误处理机制

## 7. 开发步骤规划
- **基础驱动层开发**：
  - 实现DAC7311驱动
  - 实现OLED驱动
- **传感器通信模块开发**：
  - 实现传感器通信协议
  - 测试数据读取功能
- **应用逻辑实现**：
  - 集成各模块功能
  - 实现核心数据处理
- **系统测试与调优**：
  - 功能测试
  - 性能优化

## 目录结构
```
Core/
├── Inc/                  # 头文件
│   ├── main.h           # 主程序头文件
│   ├── dac7311.h        # DAC驱动头文件
│   ├── sensor.h         # 传感器通信头文件
│   └── ...
│
├── Src/                  # 源文件
    ├── main.c           # 主程序实现
    ├── dac7311.c        # DAC驱动实现
    ├── sensor.c         # 传感器通信实现
    └── ...
```



## 使用说明


### 硬件连接
- 传感器通信(USART1): TX-PA9, RX-PA10
- 上位机通信(USART2): TX-PA2, RX-PA3
- DAC7311接口: CS-PA4, SCK-PA5, SDI-PA7
- 显示屏接口（I2C1）：SDA-PB7,SCL-PB6
- 电源指示LED: PA4
- 运行指示LED：PA5
- 按键1：PA6
- 按键2：PA7

## 校准方法（此部分内容暂不开发）
1. 将传感器置于零浓度环境中
2. 启动零点校准程序
3. 通入标准浓度的校准气体
4. 启动量程校准程序
5. 保存校准参数

## 注意事项
- 使用前请确保传感器已正确连接
- 系统启动后需要预热1分钟以获得稳定读数
- 校准必须在环境温度稳定的条件下进行




## 开发计划

### 阶段一：基础框架搭建（第1周）
1. **系统架构设计**
   - 确定代码模块划分与接口定义
   - 设计数据流程与处理流程
   - 制定通信协议与数据格式

2. **驱动层开发**
   - 完成OLED显示驱动模块开发（基于I2C）
   - 实现DAC7311驱动模块，支持数模转换输出
   - GPIO配置与控制（LED指示灯、按键接口）

### 阶段二：通信与数据处理（第2周）
1. **传感器通信模块开发**
   - 实现CF4传感器通信协议
   - 开发命令发送与数据接收功能
   - 实现数据校验与异常处理机制

2. **数据处理算法实现**
   - 实现浓度值计算算法
   - 完成浓度值到DAC输出值的映射
   - 电流信号转换算法实现

### 阶段三：系统集成与功能实现（第3周）
1. **核心功能集成**
   - 集成传感器、显示和输出模块
   - 实现主程序运行逻辑
   - 完成系统初始化与预热功能

2. **显示界面开发**
   - 设计OLED显示界面布局
   - 实现参数实时显示功能
   - 状态与错误信息显示

### 阶段四：测试与优化（第4周）
1. **单元测试**
   - 各模块功能独立测试
   - 模拟传感器数据输入测试
   - 验证DAC输出精度与响应时间

2. **系统集成测试**
   - 完整功能流程测试
   - 稳定性与可靠性测试
   - 异常情况处理测试

3. **性能优化**
   - 代码效率优化
   - 功耗与实时性能优化
   - 用户体验改进

### 交付物
1. **代码与文档**
   - 完整源代码（含注释）
   - 详细技术文档
   - 使用说明文档

2. **测试报告**
   - 功能测试报告
   - 性能测试结果
   - 已知问题与解决方案

## 开发进度
### 已完成模块
1. **DAC7311驱动模块**
   - 实现了DAC7311的SPI通信初始化
   - 完成了数据转换与电压输出功能
   - 支持不同电源模式的配置
   - 使用HAL库的SPI驱动实现，简化了接口设计
   - 解决了编码问题，优化了中文注释和文档
   - 修正了SPI通信接口参数，使用正确的引脚定义
   - 增加了错误处理功能，提高了驱动可靠性
   - 优化了电源管理模式控制

2. **传感器通信模块**
   - 完成了传感器通信协议设计与实现
   - 实现数据校验与解析功能
   - 增加通信重试机制，提高可靠性
   - 增强错误处理与状态监控功能
   - 添加详细的错误码定义与描述
   - 优化了传感器数据获取机制
   - 改进了与DAC7311模块的集成，添加故障检测

3. **数据处理算法**
   - 完成浓度值到输出值的映射算法
   - 实现电压和电流信号转换功能
   - 添加边界检查和异常保护

4. **系统框架**
   - 完成主程序运行流程设计
   - 实现系统启动、预热、初始化完整流程
   - 建立周期性数据采集和处理机制
   - 添加系统状态监控与LED指示功能

5. **OLED显示模块**
   - 完成基本驱动函数实现
   - 实现脏区更新机制，优化刷新效率
   - 设计并实现多页面显示功能
   - 完成数据显示界面的设计与开发
   - 添加进度条、条形图等图形元素
   - 实现页面自动切换功能
   - 优化显示布局和用户体验
   - 添加系统状态和错误显示功能

6. **测试与优化模块**
   - 设计并实现了完整的测试计划
   - 开发单元测试框架，测试各个模块功能
   - 实现性能测试工具，测量系统响应时间和刷新率
   - 优化关键算法，提高计算效率
   - 改进SPI通信时序，提高数据传输可靠性
   - 优化OLED刷新机制，减少不必要的更新
   - 完成系统集成测试，验证功能完整性
   - 进行代码审查和优化，提高可读性和可维护性

### 开发完成情况
整个CF4气体传感器系统开发已全部完成，包括以下方面：
- 完成了全部硬件驱动模块开发
- 实现了传感器数据采集、处理和输出全流程
- 设计并开发了用户界面和交互系统
- 进行了全面的测试和优化，提高系统稳定性和性能
- 创建了详细的测试文档和用户手册

### 2024-XX-XX 第一个稳定版本发布
1. 完成传感器通信协议的全部实现
   - 实现所有命令的发送和接收
   - 完善数据帧的校验和错误处理
   - 添加详细的调试信息输出

2. 数据解析优化
   - 统一使用32位解析所有数据类型
   - 修正字节组合顺序问题
   - 确保数据解析的准确性

3. 输出值计算优化
   - 改进计算精度
   - 添加四舍五入处理
   - 确保0~4095范围内的准确映射

4. 稳定性提升
   - 优化缓冲区管理
   - 完善错误处理机制
   - 增强通信可靠性

5. 测试验证
   - 所有命令测试通过
   - 数据解析准确性验证
   - 输出值计算准确性验证




改善计划（手工填写）
  - 1、变更USART2的传感器通讯端口为USART3,并需要修改原理图（因为根据开发板硬件电路，USART3为空闲端口，而USART2所占用的PA2,PA3连接的是指示灯，所以修改后更容易调试）
  - 2、LED设计
      修改USART2端口后，PA1,PA2修改为连接LED的GPIO端口（仍需要修改原理图），然后开始设计LED点亮逻辑，用于显示设备状态
      - LED1->PA1
      - LED2->PA2
      - 设计逻辑
         - 初始化时：
            - LED1闪烁，间隔100ms
            - 预热等待时，LED1变为常亮，同时LED2为闪烁，间隔100ms
            - 进入工作状态后，LED1常亮，LED2没更新一次DAC7311，并且需要检测成功更新后，点亮一次，维持200ms后熄灭等待下一次更新DAC7311后重复此逻辑
     
  - 3、KEY设计(暂时不开发此部分功能，无需考虑此部分的任何代码实现)
      设置PA0和PC13为KEY1\KEY2按键，用于后续传感器（下位机）的：
        - 0x01：进入标定、
        - 0x02：进入零点平移、
        - 0x06：读取标准气体值、
        - 0x07：读取AD 标气值、
        - 0x09：读取信息（气体种类，单位，小数位，反应模式）、
        - 0x11：完成标定，返回正常工作、
        - 0x12：完成零点平移，返回正常工作、
        - 0x14：设置量程值、
        - 0x16：设置标气值、
        - 0x19：设置信息（气体种类，单位，小数位，反应模式）、
        - 0x20：强制退出 ，标定过程或零点平移过程退出、
        - 0x21：恢复出厂、0x35：读取传感器地址（普通用户不能使用）、
        - 0x35：读取传感器地址（普通用户不能使用）
        - 0x36：设置传感器地址（普通用户不能使用）
        注：以上命令可能只需要实现部分功能或完全不用实现

## 工作流程

### 1. 系统初始化阶段
- 外设初始化（USART3、DAC7311、I2C1等）
- LED1闪烁（100ms间隔），指示系统正在初始化
- LED2保持熄灭

### 2. 预热等待阶段
- LED1转为常亮
- LED2开始闪烁（100ms间隔）
- 等待1分钟预热时间

### 3. 正常工作阶段
- LED1保持常亮
- LED2与DAC7311更新联动：
  - DAC7311成功更新后点亮
  - 维持200ms后熄灭
  - 等待下次更新
- 通过USART3定期读取传感器数据
- 将数据通过DAC7311转换为模拟量输出

### 4. 异常处理
- 传感器通信异常：LED指示（具体方案待定）
- DAC7311更新失败：LED2不点亮
- 系统其他异常：LED指示（具体方案待定）

### 5. 预留功能（暂不开发）
- KEY1(PA0)和KEY2(PC13)按键功能：
  - 传感器标定控制
  - 零点平移控制
  - 参数读取与设置
  - 工作模式切换
  
        