# 四氟化碳传感器系统

## 项目概述
项目名称：四氟化碳(CF4)气体浓度检测系统
核心功能：实时监测环境中CF4气体浓度并转换为标准模拟量输出
应用场景：工业环境气体监测、安全防护系统

## 系统功能
- 实时检测CF4气体浓度
- 将浓度值转换为标准模拟量输出信号(通过DAC7311)
- 支持故障检测与报警输出
- 支持参数配置与系统校准（暂不开发此部分）

## 硬件架构
- 微控制器：STM32F103C8T6，基于ARM Cortex-M3内核，最高工作频率72MHz
- 气体传感器：四氟化碳(CF4)专用传感器，通过USART1接口通信
- 数模转换器：DAC7311，12位分辨率，SPI接口控制
- 显示模块：OLED显示屏，通过I2C1接口控制
- 通信接口：
  - USART1(PA9-TX, PA10-RX)：与气体传感器建立通信，用于获取传感器数据
  - USART2(PA2-TX, PA3-RX)：与上位机通信，用于系统调试和参数配置
  - I2C1(PB6-SCL, PB7-SDA)：与OLED显示屏通信，显示系统运行状态
- 控制输出：
  - DAC7311接口(PB13-CLK, PB14-DIN, PB15-SYNC)：输出0-3.3V模拟电压信号
- 状态指示：
  - 电源指示LED(PA4)：指示系统电源状态
  - 运行指示LED(PA5)：指示系统运行状态
- 用户输入：
  - 按键1(PA6)：功能按键（暂不开发）
  - 按键2(PA7)：功能按键（暂不开发）

  

## 3. 软件架构详解

### 3.1 驱动层
- **STM32 HAL库**：硬件抽象层，提供底层外设访问接口
- **DAC7311驱动模块**：
  - 初始化DAC7311通信接口
  - 实现数据转换函数
  - 提供电压输出控制
- **UART通信模块**：
  - 配置串口参数(波特率，数据位，校验位)
  - 实现数据收发函数
  - 处理通信异常
- **GPIO控制模块**：
  - 配置引脚功能
  - 控制LED状态
  - 读取按键状态
- **I2C通信模块**：
  - 配置I2C参数
  - 实现与OLED显示屏的数据传输

### 3.2 传感器通信层
- **传感器协议实现**：
  - 根据《单一模组传感器通讯协议v2.5s-YK.pdf》文档
  - 实现命令封装与发送
  - 处理传感器响应
  - 数据校验与解析
- **数据采集流程**：
  - 周期性发送查询命令
  - 接收并解析传感器返回数据
  - 处理通信超时与错误

### 3.3 应用逻辑层
- **系统初始化**：
  - 外设初始化
  - 参数配置
  - 状态指示
- **数据处理算法**：
  - 根据零点值、量程值和当前浓度值计算实际气体浓度
  - 将浓度值映射到0-4095范围内(对应0-3.3V输出)
  - 计算输出电流(4-20mA)
- **运行状态管理**：
  - 系统启动预热(1分钟)
  - 正常运行模式
  - 错误处理

### 3.4 用户接口层
- **OLED显示模块**：
  - 初始化OLED显示
  - 界面布局设计
  - 信息更新机制
- **调试信息输出**：
  - 通过USART2输出系统状态
  - 错误日志记录

## 4. 详细工作流程

### 4.1 系统启动流程
- 硬件初始化：配置时钟、GPIO、USART、I2C
- 外设驱动初始化：DAC7311、OLED
- 点亮电源指示灯(PA4)
- 等待1分钟预热时间
- 点亮运行指示灯(PA5)，进入主循环

### 4.2 传感器数据采集流程
- **零点值获取**：
  - 发送指令0x05查询零点值
  - 接收并解析传感器响应
  - 保存零点值用于后续计算
- **量程值获取**：
  - 发送指令0x04查询量程值
  - 接收并解析传感器响应
  - 保存量程值用于后续计算
- **浓度值获取**：
  - 发送指令0x03查询当前浓度值
  - 接收并解析传感器响应
  - 保存当前浓度值

### 4.3 数据处理与输出流程
- **数值转换计算**：
  - 利用公式将当前浓度值、零点值、量程值转换为0-4095的输出值
  - 计算对应的输出电压(0-3.3V)
  - 计算对应的输出电流(4-20mA)
- **DAC7311控制**：
  - 按照DAC7311数据手册格式封装数据
  - 通过SPI接口(PB13-CLK, PB14-DIN, PB15-SYNC)发送数据
  - 实现电压输出
- **OLED显示更新**：
  - 显示零点值
  - 显示量程值
  - 显示当前气体浓度
  - 显示输出值(0-4095)
  - 显示输出电压(0-3.3V)
  - 显示输出电流(4-20mA)

### 4.4 异常处理机制
- 传感器通信超时处理
- 数据校验错误处理
- 系统运行异常处理

## 5. 代码模块划分

### 5.1 需要开发的文件
- **dac7311.c/h**：DAC7311驱动实现，提供数模转换功能
- **sensor.c/h**：传感器通信协议实现，负责与气体传感器交互
- **oled.c/h**：OLED显示屏驱动，负责信息显示
- **main.c**：主程序，实现核心业务逻辑

### 5.2 主要函数设计
- **DAC7311模块**：
  - DAC7311_Init()：初始化DAC接口
  - DAC7311_SetValue(uint16_t value)：设置DAC输出值
- **传感器模块**：
  - Sensor_Init()：初始化传感器通信
  - Sensor_GetZeroPoint()：获取零点值
  - Sensor_GetRange()：获取量程值
  - Sensor_GetConcentration()：获取当前浓度值
- **OLED模块**：
  - OLED_Init()：初始化OLED显示屏
  - OLED_ShowString(uint8_t x, uint8_t y, char *str)：显示字符串
  - OLED_ShowValue()：显示各项参数值
- **应用层**：
  - App_Init()：应用初始化
  - App_ProcessData()：数据处理与输出控制
  - App_UpdateDisplay()：更新显示信息

## 6. 重要算法与关键技术
- **浓度值映射算法**：将传感器浓度值映射到0-4095范围
  - 计算公式：outputValue = (currentConc - zeroPoint) * 4095 / (rangeValue - zeroPoint)
- **12位DAC数据封装**：
  - 按照DAC7311数据格式要求封装数据
  - 通过位操作实现高效传输
- **传感器通信协议解析**：
  - 帧格式解析
  - 校验和计算
  - 错误处理机制

## 7. 开发步骤规划
- **基础驱动层开发**：
  - 实现DAC7311驱动
  - 实现OLED驱动
- **传感器通信模块开发**：
  - 实现传感器通信协议
  - 测试数据读取功能
- **应用逻辑实现**：
  - 集成各模块功能
  - 实现核心数据处理
- **系统测试与调优**：
  - 功能测试
  - 性能优化

## 目录结构
```
Core/
├── Inc/                  # 头文件
│   ├── main.h           # 主程序头文件
│   ├── dac7311.h        # DAC驱动头文件
│   ├── sensor.h         # 传感器通信头文件
│   └── ...
│
├── Src/                  # 源文件
    ├── main.c           # 主程序实现
    ├── dac7311.c        # DAC驱动实现
    ├── sensor.c         # 传感器通信实现
    └── ...
```



## 使用说明


### 硬件连接
- 传感器通信(USART1): TX-PA9, RX-PA10
- 上位机通信(USART2): TX-PA2, RX-PA3
- DAC7311接口: CS-PA4, SCK-PA5, SDI-PA7
- 显示屏接口（I2C1）：SDA-PB7,SCL-PB6
- 电源指示LED: PA4
- 运行指示LED：PA5
- 按键1：PA6
- 按键2：PA7

## 校准方法（此部分内容暂不开发）
1. 将传感器置于零浓度环境中
2. 启动零点校准程序
3. 通入标准浓度的校准气体
4. 启动量程校准程序
5. 保存校准参数

## 注意事项
- 使用前请确保传感器已正确连接
- 系统启动后需要预热1分钟以获得稳定读数
- 校准必须在环境温度稳定的条件下进行




## 开发计划

### 阶段一：基础框架搭建（第1周）
1. **系统架构设计**
   - 确定代码模块划分与接口定义
   - 设计数据流程与处理流程
   - 制定通信协议与数据格式

2. **驱动层开发**
   - 完成OLED显示驱动模块开发（基于I2C）
   - 实现DAC7311驱动模块，支持数模转换输出
   - GPIO配置与控制（LED指示灯、按键接口）

### 阶段二：通信与数据处理（第2周）
1. **传感器通信模块开发**
   - 实现CF4传感器通信协议
   - 开发命令发送与数据接收功能
   - 实现数据校验与异常处理机制

2. **数据处理算法实现**
   - 实现浓度值计算算法
   - 完成浓度值到DAC输出值的映射
   - 电流信号转换算法实现

### 阶段三：系统集成与功能实现（第3周）
1. **核心功能集成**
   - 集成传感器、显示和输出模块
   - 实现主程序运行逻辑
   - 完成系统初始化与预热功能

2. **显示界面开发**
   - 设计OLED显示界面布局
   - 实现参数实时显示功能
   - 状态与错误信息显示

### 阶段四：测试与优化（第4周）
1. **单元测试**
   - 各模块功能独立测试
   - 模拟传感器数据输入测试
   - 验证DAC输出精度与响应时间

2. **系统集成测试**
   - 完整功能流程测试
   - 稳定性与可靠性测试
   - 异常情况处理测试

3. **性能优化**
   - 代码效率优化
   - 功耗与实时性能优化
   - 用户体验改进

### 交付物
1. **代码与文档**
   - 完整源代码（含注释）
   - 详细技术文档
   - 使用说明文档

2. **测试报告**
   - 功能测试报告
   - 性能测试结果
   - 已知问题与解决方案

## 开发进度
### 已完成模块
1. **DAC7311驱动模块**
   - 实现了DAC7311的SPI通信初始化
   - 完成了数据转换与电压输出功能
   - 支持不同电源模式的配置
   - 使用HAL库的SPI驱动实现，简化了接口设计
   - 解决了编码问题，优化了中文注释和文档
   - 修正了SPI通信接口参数，使用正确的引脚定义
   - 增加了错误处理功能，提高了驱动可靠性
   - 优化了电源管理模式控制

2. **传感器通信模块**
   - 完成了传感器通信协议设计与实现
   - 实现数据校验与解析功能
   - 增加通信重试机制，提高可靠性
   - 增强错误处理与状态监控功能
   - 添加详细的错误码定义与描述
   - 优化了传感器数据获取机制
   - 改进了与DAC7311模块的集成，添加故障检测

3. **数据处理算法**
   - 完成浓度值到输出值的映射算法
   - 实现电压和电流信号转换功能
   - 添加边界检查和异常保护

4. **系统框架**
   - 完成主程序运行流程设计
   - 实现系统启动、预热、初始化完整流程
   - 建立周期性数据采集和处理机制
   - 添加系统状态监控与LED指示功能

5. **OLED显示模块**
   - 完成基本驱动函数实现
   - 实现脏区更新机制，优化刷新效率
   - 设计并实现多页面显示功能
   - 完成数据显示界面的设计与开发
   - 添加进度条、条形图等图形元素
   - 实现页面自动切换功能
   - 优化显示布局和用户体验
   - 添加系统状态和错误显示功能

6. **测试与优化模块**
   - 设计并实现了完整的测试计划
   - 开发单元测试框架，测试各个模块功能
   - 实现性能测试工具，测量系统响应时间和刷新率
   - 优化关键算法，提高计算效率
   - 改进SPI通信时序，提高数据传输可靠性
   - 优化OLED刷新机制，减少不必要的更新
   - 完成系统集成测试，验证功能完整性
   - 进行代码审查和优化，提高可读性和可维护性

### 开发完成情况
整个CF4气体传感器系统开发已全部完成，包括以下方面：
- 完成了全部硬件驱动模块开发
- 实现了传感器数据采集、处理和输出全流程
- 设计并开发了用户界面和交互系统
- 进行了全面的测试和优化，提高系统稳定性和性能
- 创建了详细的测试文档和用户手册
